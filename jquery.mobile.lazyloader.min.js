(function(a,b){a.widget("mobile.lazyloader",a.mobile.widget,{$element:null,$page:null,$ul:null,_defaultOptions:{threshold:360,retrieve:20,retrieved:20,bubbles:false,offset:0,transform:"",icanhaz:""},_defaultParameters:{retrieve:20,retrieved:20,offset:0},_defaultSettings:{pageId:"",mainId:"",progressDivId:"",moreUrl:"",clearUrl:""},_defaultSelectors:{main:"ul",single:"ul li",bottom:'[data-role="list-divider"]'},_handleScrollStartJustFired:false,_handleScrollStopJustFired:false,_mouseWheelEventJustFired:false,_handleScrollStartTimeoutId:null,_handleScrollStopTimeoutId:null,_mouseWheelTimeoutId:null,_instances:{},_moreOutstandingPageId:null,parameters:null,_settings:null,_selectors:null,timeoutOptions:{mousewheel:400,scrollstart:600,scrollstop:60,showprogress:200,scrolldown:400,immediately:0},_widgetName:"lazyloader",_widgetState:{busy:false,done:false},_create:function(){this._initialize(this._defaultOptions,this._defaultSettings,this._defaultParameters,this._defaultSelectors);this._bind()},_init:function(){},_initialize:function(d,f,g,e){if((typeof d!="undefined")&&(d!="")){this._widgetState.busy=false;this._widgetState.done=false;this._settings=a.extend(true,this._settings,this._defaultSettings);this._settings=a.extend(true,this._settings,f);if((typeof this._settings.mainId!=="undefined")&&(this._settings.mainId!=="")){this._defaultSelectors.main="#"+this._settings.mainId;this._defaultSelectors.single="#"+this._settings.mainId+" li";this._defaultSelectors.bottom='[data-role="list-divider"]'}this._selectors=a.extend(true,this._selectors,this._defaultSelectors);this._selectors=a.extend(true,this._selectors,e);this.parameters=a.extend(true,this.parameters,this._defaultParameters);this.parameters=a.extend(true,this.parameters,g);this.options=a.extend(true,this.options,this._defaultOptions);this.options=a.extend(true,this.options,d);var c=f.pageId;if((typeof c!="undefined ")&&(c!="")){if(!this._instances[c]){optionsAsString=JSON.stringify(this.options);settingsAsString=JSON.stringify(this._settings);selectorsAsString=JSON.stringify(this._selectors);this._instances[c]=[];this._instances[c]["options"]=a.parseJSON(optionsAsString);this._instances[c]["settings"]=a.parseJSON(settingsAsString);this._instances[c]["selectors"]=a.parseJSON(selectorsAsString)}}this.$element=this.element;this.$page=this.$element.parents(":jqmData(role='page')");this.$ul=a(":jqmData(role='listview')")}},_bind:function(){a("body").bind("scrollstart",a.proxy(this._handleScrollStart,this));a("body").bind("scrollstop",a.proxy(this._handleScrollStop,this));if(/Firefox/i.test(navigator.userAgent)){a(window).bind("DOMMouseScroll",a.proxy(this._handleMouseWheelEvent,this))}else{if((typeof this._selectors!="undefined")&&(this._selectors!=null)&&(this._selectors!="")){if(typeof this._selectors.main!="undefined"){if(a(this._selectors.main).attachEvent){a(window).bind("onmousewheel",a.proxy(this._handleMouseWheelEvent,this))}else{a(window).bind("mousewheel",a.proxy(this._handleMouseWheelEvent,this))}}}}},_unbind:function(){a("body").unbind("scrollstart",this._handleScrollStart);a("body").unbind("scrollstop",this._handleScrollStop);if(/Firefox/i.test(navigator.userAgent)){a(window).unbind("DOMMouseScroll",this._handleMouseWheelEvent)}else{if((typeof this._selectors!="undefined")&&(this._selectors!=null)&&(this._selectors!="")){if(typeof this._selectors.main!="undefined"){if(a(this._selectors.main).attachEvent){a(window).unbind("onmousewheel",this._handleMouseWheelEvent)}else{a(window).unbind("mousewheel",this._handleMouseWheelEvent)}}}}},destroy:function(){this._unbind();this.$element=null;this.$page=null;this.$ul=null;this._settings=null;this.options=null;this.parameters=null;this._instances=null;this._handleScrollStartJustFired=null;this._handleScrollStopJustFired=null;this._mouseWheelEventJustFired=null;this._handleScrollStartTimeoutId=null;this._handleScrollStopTimeoutId=null;this._mouseWheelTimeoutId=null;this._widgetState=null;this._defaultOptions=null;this._defaultSettings=null;this._defaultParameters=null;this.timeoutOptions=null;a.Widget.prototype.destroy.apply(this)},_check:function(c){c=this.options.threshold||c;var d,f,e;if(document.documentElement.scrollTop){f=document.documentElement.scrollTop}else{f=document.body.scrollTop}d=a("#"+this._settings.pageId).height();e=a(window).height();return((d-c)<=(f+e))},_load:function(c){if((typeof this._settings.pageId!=b)&&(this._settings.pageId!="")){if(a(".ui-page-active").attr("id")==this._settings.pageId){if((!this._widgetState.busy)&&(!this._widgetState.done)){this._moreOutstandingPageId=this._settings.pageId;$that=this;setTimeout(function(){if($that._moreOutstandingPageId==$that._settings.pageId){if($that._check($that.options.threshold)||(c===0)){a("#"+$that._settings.progressDivId).show($that.timeoutOptions.showprogress,function(){moreUrl=$that._settings.moreUrl;var h="";var g=0;if($that._instances[$that._settings.pageId]){$that.parameters.retrieve=$that._instances[$that._settings.pageId]["options"].retrieve;$that.parameters.retrieved=$that._instances[$that._settings.pageId]["options"].retrieved;$that.parameters.offset=$that._instances[$that._settings.pageId]["options"].offset}else{$that.parameters.retrieve=$that.options.retrieve;$that.parameters.retrieved=$that.options.retrieved;$that.parameters.offset=$that.options.offset}if((typeof $that._settings.pageId!="undefined")&&($that._settings.pageId!="")){var d=a("#"+$that._settings.pageId).find('[type="hidden"]');for(i=0;i<d.length;i++){var f=a(d).get(i);if((typeof a(f).attr("id")!="undefined")&&(a(f).attr("id")!="")){$that.parameters[a(f).attr("id")]=escape(a(f).val())}}}for(var e in $that.parameters){if(g==0){h+=(e+"="+$that.parameters[e])}else{h+=("&"+e+"="+$that.parameters[e])}g=g+1}a.ajax({type:"POST",url:moreUrl,async:true,data:h,success:function(j){var p=a.parseJSON(j);var n=p.data[0].count;var m="";var u="";var k="";var q="";var o="";var t="";var r="";var l="";if(n>0){o=$that._selectors.main;t=$that._selectors.single;r=$that._selectors.bottom;l=$that._getBottomElement(o,r);if((typeof p.data[0].html!="undefined")&&(p.data[0].html!="")){m=p.data[0].html;if(l){a(t).last().before(m)}else{a(o).append(m)}}else{u=p.data[0].json;if((typeof u!="undefined")&&(u!="")){if((typeof $that.options.transform!="undefined")&&($that.options.transform!="")){k=$that.options.transform}if($that._instances[$that._settings.pageId]){if((typeof $that._instances[$that._settings.pageId]["options"].transform!="undefined")&&($that._instances[$that._settings.pageId]["options"].transform!="")){k=$that._instances[$that._settings.pageId]["options"].transform}}if((typeof $that.options.icanhaz!="undefined")&&($that.options.icanhaz!="")){q=$that.options.icanhaz}if($that._instances[$that._settings.pageId]){if((typeof $that._instances[$that._settings.pageId]["options"].icanhaz!="undefined")&&($that._instances[$that._settings.pageId]["options"].icanhaz!="")){q=$that._instances[$that._settings.pageId]["options"].icanhaz}}if(q!=""){ich.addTemplate("listitem",q);for(i=0;i<u.length;i++){var s=ich.listitem(u[i],true);m+=s}ich.clearAll();if(l){a(t).last().before(m)}else{a(o).append(m)}}else{if(k!=""){if(l){l.remove()}a(o).json2html(u,k);if(l){a(t).last().append(l)}}}}}a(o).listview("refresh");$that._instances[$that._settings.pageId]["options"].retrieved+=parseInt(n);if((n<$that.options.retrieve)||($that.options.retrieve=="all")){$that._widgetState.done=true;$that._triggerEvent("alldone","_load")}}else{$that._widgetState.done=true;$that._triggerEvent("alldone","_load")}a("#"+$that._settings.progressDivId).hide(250,function(){$that._widgetState.busy=false});$that._triggerEvent("doneloading","_load")},error:function(j){$that._triggerEvent("error","_load",j);a("#"+$that._settings.progressDivId).hide(250,function(){$that._widgetState.busy=false})}})})}}},c)}else{if(this._widgetState.done){$that._triggerEvent("alldone","_load")}else{if(this._widgetState.busy){$that._triggerEvent("busy","_load")}else{}}}}else{a("#"+this._settings.progressDivId).hide(250,function(){if(typeof this._widgetState!="undefined"){this._widgetState.busy=false}})}}},_getBottomElement:function(d,e){var c=a(d).last().find(e);switch(c.length){case 2:c=c.last();break;case 1:case 0:default:c=null;break}if((typeof c!="undefined")&&(c!=null)&&(c!="")&&(c!="null")){return c}else{return false}},_handleMouseWheelEvent:function(){if((!this._mouseWheelEventJustFired)&&(!this._handleScrollStopJustFired)&&(!this._handleScrollStartJustFired)){this._mouseWheelEventJustFired=true;this._load(this.timeoutOptions.mousewheel);var c=this;this._mouseWheelTimeoutId=setTimeout(function(){c._mouseWheelEventJustFired=false},1000)}},_handleScrollStart:function(){if((!this._mouseWheelEventJustFired)&&(!this._handleScrollStopJustFired)&&(!this._handleScrollStartJustFired)){this._handleScrollStartJustFired=true;this._load(this.timeoutOptions.scrollstart);var c=this;this._handleScrollStartTimeoutId=setTimeout(function(){c._handleScrollStartJustFired=false},1200)}},_handleScrollStop:function(){if((!this._mouseWheelEventJustFired)&&(!this._handleScrollStopJustFired)&&(!this._handleScrollStartJustFired)){this._handleScrollStopJustFired=true;this._load(this.timeoutOptions.scrollstop);var c=this;this._handleScrollStopTimeoutId=setTimeout(function(){c._handleScrollStopJustFired=false},1200)}},loadMore:function(c){if(c===0){this._load(this.timeoutOptions.immediately)}else{this._load(this.timeoutOptions.scrolldown)}},_setOption:function(c,d){if(this._instances[this._settings.pageId]){if(this._instances[this._settings.pageId]["options"][c]){this._instances[this._settings.pageId]["options"][c]=d}}a.Widget.prototype._setOption.apply(this,arguments)},refresh:function(e){if(e=="parameters"){if(typeof this.options!="undefined"){for(var d in this.parameters){if(typeof this.options[d]!="undefined"){this.parameters[d]=this.options[d]}}}}else{if(e=="parameter"){var d=arguments[1];if(typeof this.options[d]!="undefined"){this.parameters[d]=this.options[d]}}else{}}var c=JSON.stringify(this.parameters);this.parameters=a.parseJSON(c)},reInitialize:function(c,e,f,d){c=""||c;e=""||e;f=""||f;d=""||d;this._initialize(c,e,f,d)},reset:function(d){var c=this;a.ajax({type:"POST",url:c._settings.clearUrl,async:true,data:"section="+d,success:function(f){if(parseInt(f)){c.options.retrieved=c._defaultOptions.retrieved;c._widgetState.done=false;if(typeof c._instances[d]!="undefined"){delete c._instances[d]}var e="All session variables for the '"+d+"' page and the lazyloader instance variables have been cleared.";c._triggerEvent("reset","reset",e)}},error:function(e){c._triggerEvent("error","reset",e);a("#"+c._settings.progressDivId).hide(250,function(){c._widgetState.busy=false})}})},resetAll:function(){var c=this;a.ajax({type:"POST",url:c._settings.clearUrl,async:true,data:"",success:function(e){if(parseInt(e)){for(pageId in c._instances){delete c._instances[pageId]}c.options.retrieved=c._defaultOptions.retrieved;c._widgetState.done=false;c._widgetState.busy=false;var d="All session variables for all pages currently being tracked by the lazyloader have been cleared.";c._triggerEvent("resetall","resetAll",d)}}})},_triggerEvent:function(d,c,e){e=e||"";switch(d){case"error":case"resetall":this._trigger(d,{type:"lazyloader"+d,"function":c,message:e,settings:this._settings,options:this.options,parameters:this.parameters});break;default:this._trigger(d,{type:"lazyloader"+d,"function":c,message:e,pageId:this._settings.pageId,mainId:this._settings.mainId,loaded:this.options.retrieved});break}}});a(document).bind("pagecreate create",function(c){a.mobile.lazyloader.prototype.enhanceWithin(c.target)})})(jQuery);