(function(a,m){a.widget("mobile.lazyloader",a.mobile.widget,{$element:null,$page:null,$ul:null,_defaultOptions:{threshold:360,retrieve:20,retrieved:20,bubbles:!1,offset:0,transform:"",icanhaz:"",template:""},_defaultParameters:{retrieve:20,retrieved:20,offset:0},_defaultSettings:{pageId:"",mainId:"",progressDivId:"",moreUrl:"",clearUrl:""},_defaultSelectors:{main:"ul",single:"ul li",bottom:'[data-role="list-divider"]'},_handleScrollStartJustFired:!1,_handleScrollStopJustFired:!1,_mouseWheelEventJustFired:!1,
_handleScrollStartTimeoutId:null,_handleScrollStopTimeoutId:null,_mouseWheelTimeoutId:null,_instances:{},_moreOutstandingPageId:null,parameters:null,_settings:null,_selectors:null,timeoutOptions:{mousewheel:400,scrollstart:600,scrollstop:60,showprogress:200,scrolldown:400,immediately:0},_widgetName:"lazyloader",_widgetState:{busy:!1,done:!1},_create:function(){this._initialize(this._defaultOptions,this._defaultSettings,this._defaultParameters,this._defaultSelectors);this._bind()},_init:function(){},
_initialize:function(b,d,c,e){"undefined"!=typeof b&&""!=b&&(this._widgetState.busy=!1,this._widgetState.done=!1,this._settings=a.extend(!0,this._settings,this._defaultSettings),this._settings=a.extend(!0,this._settings,d),"undefined"!==typeof this._settings.mainId&&""!==this._settings.mainId&&(this._defaultSelectors.main="#"+this._settings.mainId,this._defaultSelectors.single="#"+this._settings.mainId+" li",this._defaultSelectors.bottom='[data-role="list-divider"]'),this._selectors=a.extend(!0,this._selectors,
this._defaultSelectors),this._selectors=a.extend(!0,this._selectors,e),this.parameters=a.extend(!0,this.parameters,this._defaultParameters),this.parameters=a.extend(!0,this.parameters,c),this.options=a.extend(!0,this.options,this._defaultOptions),this.options=a.extend(!0,this.options,b),b=d.pageId,"undefined "!=typeof b&&""!=b&&!this._instances[b]&&(optionsAsString=JSON.stringify(this.options),settingsAsString=JSON.stringify(this._settings),selectorsAsString=JSON.stringify(this._selectors),this._instances[b]=
[],this._instances[b].options=a.parseJSON(optionsAsString),this._instances[b].settings=a.parseJSON(settingsAsString),this._instances[b].selectors=a.parseJSON(selectorsAsString)),this.$element=this.element,this.$page=this.$element.parents(":jqmData(role='page')"),this.$ul=a(":jqmData(role='listview')"))},_bind:function(){a("body").bind("scrollstart",a.proxy(this._handleScrollStart,this));a("body").bind("scrollstop",a.proxy(this._handleScrollStop,this));/Firefox/i.test(navigator.userAgent)?a(window).bind("DOMMouseScroll",
a.proxy(this._handleMouseWheelEvent,this)):"undefined"!=typeof this._selectors&&null!=this._selectors&&""!=this._selectors&&"undefined"!=typeof this._selectors.main&&(a(this._selectors.main).attachEvent?a(window).bind("onmousewheel",a.proxy(this._handleMouseWheelEvent,this)):a(window).bind("mousewheel",a.proxy(this._handleMouseWheelEvent,this)))},_unbind:function(){a("body").unbind("scrollstart",this._handleScrollStart);a("body").unbind("scrollstop",this._handleScrollStop);/Firefox/i.test(navigator.userAgent)?
a(window).unbind("DOMMouseScroll",this._handleMouseWheelEvent):"undefined"!=typeof this._selectors&&null!=this._selectors&&""!=this._selectors&&"undefined"!=typeof this._selectors.main&&(a(this._selectors.main).attachEvent?a(window).unbind("onmousewheel",this._handleMouseWheelEvent):a(window).unbind("mousewheel",this._handleMouseWheelEvent))},destroy:function(){this._unbind();this.timeoutOptions=this._defaultParameters=this._defaultSettings=this._defaultOptions=this._widgetState=this._mouseWheelTimeoutId=
this._handleScrollStopTimeoutId=this._handleScrollStartTimeoutId=this._mouseWheelEventJustFired=this._handleScrollStopJustFired=this._handleScrollStartJustFired=this._instances=this.parameters=this.options=this._settings=this.$ul=this.$page=this.$element=null;a.Widget.prototype.destroy.apply(this)},_check:function(b){var b=this.options.threshold||b,d,c,e;c=document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop;d=a("#"+this._settings.pageId).height();e=a(window).height();
return d-b<=c+e},_load:function(b){typeof this._settings.pageId!=m&&""!=this._settings.pageId&&(a(".ui-page-active").attr("id")==this._settings.pageId?!this._widgetState.busy&&!this._widgetState.done?(this._moreOutstandingPageId=this._settings.pageId,$that=this,setTimeout(function(){$that._moreOutstandingPageId==$that._settings.pageId&&($that._check($that.options.threshold)||0===b)&&a("#"+$that._settings.progressDivId).show($that.timeoutOptions.showprogress,function(){moreUrl=$that._settings.moreUrl;
var b="",c=0;$that._instances[$that._settings.pageId]?($that.parameters.retrieve=$that._instances[$that._settings.pageId].options.retrieve,$that.parameters.retrieved=$that._instances[$that._settings.pageId].options.retrieved,$that.parameters.offset=$that._instances[$that._settings.pageId].options.offset):($that.parameters.retrieve=$that.options.retrieve,$that.parameters.retrieved=$that.options.retrieved,$that.parameters.offset=$that.options.offset);if("undefined"!=typeof $that._settings.pageId&&""!=
$that._settings.pageId){var e=a("#"+$that._settings.pageId).find('[type="hidden"]');for(i=0;i<e.length;i++){var g=a(e).get(i);"undefined"!=typeof a(g).attr("id")&&""!=a(g).attr("id")&&($that.parameters[a(g).attr("id")]=escape(a(g).val()))}}for(var h in $that.parameters)b=0==c?b+(h+"="+$that.parameters[h]):b+("&"+h+"="+$that.parameters[h]),c+=1;a.ajax({type:"POST",url:moreUrl,async:!0,data:b,success:function(b){var c=a.parseJSON(b),b=c.data[0].count,d="",f="",e="",g="",h="",k="",l="",j=f="";if(b>0){k=
$that._selectors.main;l=$that._selectors.single;f=$that._selectors.bottom;j=$that._getBottomElement(k,f);if(typeof c.data[0].html!="undefined"&&c.data[0].html!=""){d=c.data[0].html;j?a(l).last().before(d):a(k).append(d)}else{f=c.data[0].json;if(typeof f!="undefined"&&f!=""){if(typeof $that.options.transform!="undefined"&&$that.options.transform!="")e=$that.options.transform;if($that._instances[$that._settings.pageId]&&typeof $that._instances[$that._settings.pageId].options.transform!="undefined"&&
$that._instances[$that._settings.pageId].options.transform!="")e=$that._instances[$that._settings.pageId].options.transform;if(typeof $that.options.icanhaz!="undefined"&&$that.options.icanhaz!="")g=$that.options.icanhaz;if($that._instances[$that._settings.pageId]&&typeof $that._instances[$that._settings.pageId].options.icanhaz!="undefined"&&$that._instances[$that._settings.pageId].options.icanhaz!="")g=$that._instances[$that._settings.pageId].options.icanhaz;if(typeof $that.options.template!="undefined"&&
$that.options.template!="")h=$that.options.template;if($that._instances[$that._settings.pageId]&&typeof $that._instances[$that._settings.pageId].options.template!="undefined"&&$that._instances[$that._settings.pageId].options.template!="")h=$that._instances[$that._settings.pageId].options.template;if(h!==""){dust.loadSource(h);for(i=0;i<f.length;i++)dust.render("listview",f[i],function(b,a){d=d+a});j?a(l).last().before(d):a(k).append(d)}else if(g!==""){ich.addTemplate("listitem",g);for(i=0;i<f.length;i++){c=
ich.listitem(f[i],true);d=d+c}ich.clearAll();j?a(l).last().before(d):a(k).append(d)}else if(e!==""){j&&j.remove();a(k).json2html(f,e);j&&a(l).last().append(j)}}}a(k).listview("refresh");$that._instances[$that._settings.pageId].options.retrieved=$that._instances[$that._settings.pageId].options.retrieved+parseInt(b);if(b<$that.options.retrieve||$that.options.retrieve=="all"){$that._widgetState.done=true;$that._triggerEvent("alldone","_load")}}else{$that._widgetState.done=true;$that._triggerEvent("alldone",
"_load")}a("#"+$that._settings.progressDivId).hide(250,function(){$that._widgetState.busy=false});$that._triggerEvent("doneloading","_load")},error:function(b){$that._triggerEvent("error","_load",b);a("#"+$that._settings.progressDivId).hide(250,function(){$that._widgetState.busy=false})}})})},b)):this._widgetState.done?$that._triggerEvent("alldone","_load"):this._widgetState.busy&&$that._triggerEvent("busy","_load"):a("#"+this._settings.progressDivId).hide(250,function(){"undefined"!=typeof this._widgetState&&
(this._widgetState.busy=!1)}))},_getBottomElement:function(b,d){var c=a(b).last().find(d);switch(c.length){case 2:c=c.last();break;default:c=null}return"undefined"!=typeof c&&null!=c&&""!=c&&"null"!=c?c:!1},_handleMouseWheelEvent:function(){if(!this._mouseWheelEventJustFired&&!this._handleScrollStopJustFired&&!this._handleScrollStartJustFired){this._mouseWheelEventJustFired=!0;this._load(this.timeoutOptions.mousewheel);var b=this;this._mouseWheelTimeoutId=setTimeout(function(){b._mouseWheelEventJustFired=
!1},1E3)}},_handleScrollStart:function(){if(!this._mouseWheelEventJustFired&&!this._handleScrollStopJustFired&&!this._handleScrollStartJustFired){this._handleScrollStartJustFired=!0;this._load(this.timeoutOptions.scrollstart);var b=this;this._handleScrollStartTimeoutId=setTimeout(function(){b._handleScrollStartJustFired=!1},1200)}},_handleScrollStop:function(){if(!this._mouseWheelEventJustFired&&!this._handleScrollStopJustFired&&!this._handleScrollStartJustFired){this._handleScrollStopJustFired=!0;
this._load(this.timeoutOptions.scrollstop);var b=this;this._handleScrollStopTimeoutId=setTimeout(function(){b._handleScrollStopJustFired=!1},1200)}},loadMore:function(b){0===b?this._load(this.timeoutOptions.immediately):this._load(this.timeoutOptions.scrolldown)},_setOption:function(b,d){this._instances[this._settings.pageId]&&this._instances[this._settings.pageId].options[b]&&(this._instances[this._settings.pageId].options[b]=d);a.Widget.prototype._setOption.apply(this,arguments)},refresh:function(b,
d){if("parameters"==b){if("undefined"!=typeof this.options)for(var c in this.parameters)"undefined"!=typeof this.options[c]&&(this.parameters[c]=this.options[c])}else"parameter"==b&&(c=d,"undefined"!=typeof this.options[c]&&(this.parameters[c]=this.options[c]));c=JSON.stringify(this.parameters);this.parameters=a.parseJSON(c)},reInitialize:function(b,a,c,e){this._initialize(b,a,c,e)},reset:function(b){var d=this;a.ajax({type:"POST",url:d._settings.clearUrl,async:!0,data:"section="+b,success:function(a){parseInt(a)&&
(d.options.retrieved=d._defaultOptions.retrieved,d._widgetState.done=!1,"undefined"!=typeof d._instances[b]&&delete d._instances[b],d._triggerEvent("reset","reset","All session variables for the '"+b+"' page and the lazyloader instance variables have been cleared."))},error:function(b){d._triggerEvent("error","reset",b);a("#"+d._settings.progressDivId).hide(250,function(){d._widgetState.busy=!1})}})},resetAll:function(){var b=this;a.ajax({type:"POST",url:b._settings.clearUrl,async:!0,data:"",success:function(a){if(parseInt(a)){for(pageId in b._instances)delete b._instances[pageId];
b.options.retrieved=b._defaultOptions.retrieved;b._widgetState.done=!1;b._widgetState.busy=!1;b._triggerEvent("resetall","resetAll","All session variables for all pages currently being tracked by the lazyloader have been cleared.")}}})},_triggerEvent:function(b,a,c){c=c||"";switch(b){case "error":case "resetall":this._trigger(b,{type:"lazyloader"+b,"function":a,message:c,settings:this._settings,options:this.options,parameters:this.parameters});break;default:this._trigger(b,{type:"lazyloader"+b,"function":a,
message:c,pageId:this._settings.pageId,mainId:this._settings.mainId,loaded:this.options.retrieved})}}});a(document).bind("pagecreate create",function(b){a.mobile.lazyloader.prototype.enhanceWithin(b.target)})})(jQuery);
